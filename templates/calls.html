<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOIP Call Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #16a34a;
            --warning-color: #ca8a04;
            --danger-color: #dc2626;
            --light-bg: #f8fafc;
            --dark-bg: #1e293b;
        }

        body {
            background: var(--light-bg);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-bg);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--secondary-color);
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .calls-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .section-header {
            background: var(--light-bg);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-bg);
            margin: 0;
        }

        .call-item {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #f1f5f9;
            transition: background-color 0.2s ease;
        }

        .call-item:hover {
            background-color: #f8fafc;
        }

        .call-item:last-child {
            border-bottom: none;
        }
        
        /* AMI Call Styling */
        .call-item.ami-call {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }
        
        .call-item.ami-call:hover {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }
        
        .call-item.ami-call .caller-info h5 {
            color: #92400e;
        }
        
        .call-item.ami-call .call-status {
            background: #f59e0b;
            color: white;
        }
        
        /* Call Source Summary Styling */
        .call-source-summary {
            margin: 2rem 0;
        }
        
        .source-card {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .source-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .ami-source {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #f59e0b;
        }
        
        .phone-source {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #3b82f6;
        }
        
        .source-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.5rem;
        }
        
        .ami-source .source-icon {
            background: #f59e0b;
            color: white;
        }
        
        .phone-source .source-icon {
            background: #3b82f6;
            color: white;
        }
        
        .source-info h6 {
            margin: 0 0 0.5rem 0;
            font-weight: 600;
            color: var(--dark-bg);
        }
        
        .source-count {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-bg);
            margin-bottom: 0.25rem;
        }

        .call-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .caller-info h5 {
            margin: 0;
            font-weight: 600;
            color: var(--dark-bg);
        }

        .caller-info small {
            color: var(--secondary-color);
        }

        .call-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-incoming { background: #fef3c7; color: #92400e; }
        .status-active { background: #dcfce7; color: #166534; }
        .status-ended { background: #fee2e2; color: #991b1b; }

        .call-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .btn-call-action {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            border: none;
            transition: all 0.2s ease;
        }

        .btn-call-action:hover {
            transform: translateY(-1px);
        }

        .btn-answer { background: var(--success-color); color: white; }
        .btn-hangup { background: var(--danger-color); color: white; }
        .btn-record { background: var(--warning-color); color: white; }

        /* Audio Player Styles */
        .audio-player-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
        }

        .audio-player-container audio {
            border-radius: 8px;
        }

        .audio-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .recording-info {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
        }

        .recording-info h6 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .recording-info p {
            margin-bottom: 0.5rem;
            color: var(--dark-bg);
        }

        .recording-info strong {
            color: var(--primary-color);
        }

        /* Enhanced Filter Styles */
        .search-filter {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .search-filter .form-control,
        .search-filter .form-select {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            transition: all 0.2s ease;
        }

        .search-filter .form-control:focus,
        .search-filter .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            transform: translateY(-1px);
        }

        /* Play Button Enhancement */
        .btn-outline-success {
            border-color: var(--success-color);
            color: var(--success-color);
            transition: all 0.2s ease;
        }

        .btn-outline-success:hover {
            background-color: var(--success-color);
            border-color: var(--success-color);
            color: white;
            transform: translateY(-1px);
        }

        .no-calls {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--secondary-color);
        }

        .no-calls i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Incident Report Modal Styles */
        .modal-content {
            border-radius: 16px;
            border: none;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--success-color), #15803d);
            color: white;
            border-radius: 16px 16px 0 0;
            border: none;
            padding: 1.5rem 2rem;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1.25rem;
        }

        .modal-body {
            padding: 2rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--dark-bg);
            margin-bottom: 0.5rem;
        }

        .map-container {
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .btn-submit {
            background: var(--success-color);
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            color: white;
            transition: all 0.2s ease;
        }

        .btn-submit:hover {
            background: #15803d;
            transform: translateY(-1px);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn-action {
                width: 100%;
                justify-content: center;
            }
            
            .call-header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .call-actions {
                justify-content: center;
            }
        }

        /* Audio Recording Status */
        .recording-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #fee2e2;
            color: #991b1b;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .recording-status i {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-phone-alt me-2"></i>
                VOIP Call Management
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">
                    <i class="fas fa-chart-line me-1"></i>Dashboard
                </a>
                <a class="nav-link active" href="/calls">
                    <i class="fas fa-phone me-1"></i>Calls
                </a>
                <a class="nav-link" href="/phone">
                    <i class="fas fa-mobile-alt me-1"></i>Phone Simulator
                </a>
                </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h2 mb-2">
                        <i class="fas fa-phone-alt text-primary me-2"></i>
                        Call Management Center
                    </h1>
                    <p class="text-muted mb-0">Manage incoming calls, monitor call activity, and handle incident reports</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-outline-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
            </div>
        </div>
    </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--primary-color);">
                    <i class="fas fa-phone-volume"></i>
                    </div>
                <div class="stat-number" id="totalCalls">0</div>
                <div class="stat-label">Total Calls</div>
                        </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--success-color);">
                    <i class="fas fa-phone"></i>
                </div>
                <div class="stat-number" id="activeCalls">0</div>
                <div class="stat-label">Active Calls</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--warning-color);">
                    <i class="fas fa-microphone"></i>
        </div>
                <div class="stat-number" id="totalRecordings">0</div>
                <div class="stat-label">Recordings</div>
                    </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--danger-color);">
                    <i class="fas fa-exclamation-triangle"></i>
                        </div>
                <div class="stat-number" id="pendingReports">0</div>
                <div class="stat-label">Pending Reports</div>
                        </div>
        </div>
        
        <!-- Call Source Summary -->
        <div class="call-source-summary">
            <div class="row">
                <div class="col-md-6">
                    <div class="source-card ami-source">
                        <div class="source-icon">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <div class="source-info">
                            <h6>AMI Calls (Extension 1412)</h6>
                            <div class="source-count" id="amiCallCount">0</div>
                            <small class="text-muted">Calls from Asterisk PBX</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="source-card phone-source">
                        <div class="source-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="source-info">
                            <h6>Phone Simulator</h6>
                            <div class="source-count" id="phoneCallCount">0</div>
                            <small class="text-muted">Test calls from simulator</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="action-buttons">
            <button class="btn btn-action btn-warning" onclick="testAGICall()">
                <i class="fas fa-phone-alt"></i>
                Test AGI Call
            </button>
            <button class="btn btn-action btn-info" onclick="exportData()">
                <i class="fas fa-download"></i>
                Export Data
            </button>
            <button class="btn btn-action btn-secondary" onclick="showAnalytics()">
                <i class="fas fa-chart-bar"></i>
                Analytics
            </button>
            <!-- <button class="btn btn-action btn-warning" onclick="testCallLoading()">
                <i class="fas fa-bug"></i>
                Test Calls
            </button>
            <button class="btn btn-action btn-dark" onclick="debugCurrentState()">
                <i class="fas fa-info-circle"></i>
                Debug
            </button>
            <button class="btn btn-action btn-outline-warning" onclick="testRecordingSave()">
                <i class="fas fa-save"></i>
                Test Recording Save
            </button> -->
        </div>
        
        <!-- Search and Filter -->
        <div class="search-filter">
            <div class="row">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search calls, names, numbers...">
                    </div>
                <div class="col-md-2">
                    <input type="text" class="form-control" id="phoneFilter" placeholder="Filter by phone number">
                            </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="incoming">Incoming</option>
                        <option value="active">Active</option>
                        <option value="ended">Ended</option>
                        <option value="missed">Missed</option>
                        <option value="completed">Completed</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="sourceFilter">
                        <option value="">All Sources</option>
                        <option value="ami">AMI Calls</option>
                        <option value="phone_simulator">Phone Simulator</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="date" class="form-control" id="dateFilter">
                        </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="applyFilters()">
                        <i class="fas fa-search me-1"></i>Filter
                    </button>
                    </div>
                </div>
            <div class="row mt-2">
                <div class="col-12">
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i>Clear All Filters
                    </button>
            </div>
        </div>
    </div>

        <!-- Calls List -->
        <div class="calls-section">
            <div class="section-header">
                <h5 class="section-title">
                    <i class="fas fa-list me-2"></i>
                    Call History
                        </h5>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-muted" id="callsCount">0 calls</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadCalls()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
            <div id="callsContainer">
                <!-- Calls will be loaded here -->
                </div>
                        </div>
                    </div>

    <!-- Incident Report Modal -->
    <div class="modal fade" id="incidentModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Report Incident - Call #<span id="callIdDisplay"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="incidentForm">
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="mb-4">
                                    <h6 class="fw-bold mb-3">
                                        <i class="fas fa-edit me-2"></i>Incident Details
                                    </h6>
                                    
    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="title" class="form-label">Incident Title *</label>
                                                <input type="text" class="form-control" id="title" name="title" required>
                        </div>
                    </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="category_id" class="form-label">Category *</label>
                                                <select class="form-select" id="category_id" name="category_id" required onchange="updateCategoryInfo()">
                                                    <option value="">Select Category</option>
                                                    <!-- Categories will be loaded dynamically -->
                                                </select>
                                                <div id="categoryInfo" class="mt-2" style="display: none;">
                                                    <small class="text-muted">
                                                        <span id="categoryPriority"></span> | 
                                                        <span id="categoryResponseTime"></span>
                                                    </small>
                </div>
            </div>
        </div>
    </div>

                                    <div class="mb-3">
                                        <label for="description" class="form-label">Description *</label>
                                        <textarea class="form-control" id="description" name="description" rows="4" 
                                                  placeholder="Describe the incident in detail..." required></textarea>
        </div>
                                    
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                                                <label for="priority" class="form-label">Priority *</label>
                                                <select class="form-select" id="priority" name="priority" required>
                                                    <option value="low">Low</option>
                                                    <option value="medium" selected>Medium</option>
                                                    <option value="high">High</option>
                                                    <option value="critical">Critical</option>
                                                </select>
                    </div>
                    </div>
                                        <div class="col-md-6">
                    <div class="mb-3">
                                                <label for="caller_number" class="form-label">Caller Number</label>
                                                <input type="text" class="form-control" id="caller_number" name="caller_number" readonly>
                    </div>
                </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="location_name" class="form-label">Location Name *</label>
                                        <input type="text" class="form-control" id="location_name" name="location_name" required>
                                    </div>
                                    
                                    <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                                                <label for="latitude" class="form-label">Latitude *</label>
                                                <input type="number" step="any" class="form-control" id="latitude" name="latitude" required>
                        </div>
                    </div>
                                        <div class="col-md-6">
                    <div class="mb-3">
                                                <label for="longitude" class="form-label">Longitude *</label>
                                                <input type="number" step="any" class="form-control" id="longitude" name="longitude" required>
                                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
                            <div class="col-lg-4">
                                <div class="mb-4">
                                    <h6 class="fw-bold mb-3">
                                        <i class="fas fa-map-marked-alt me-2"></i>Select Location
                                    </h6>
                                    <div id="map" class="map-container"></div>
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Click on the map to select the incident location. Coordinates will be automatically filled.
                                        </small>
                </div>
            </div>
            
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-submit">
                                        <i class="fas fa-save me-2"></i>Submit Report
                                    </button>
                    </div>
                    </div>
                </div>
                    </form>
            </div>
        </div>
    </div>
</div>

    <!-- Audio Player Modal -->
    <div class="modal fade" id="audioPlayerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
        <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title">
                        <i class="fas fa-play-circle me-2"></i>
                        Play Recording - Call #<span id="audioCallIdDisplay"></span>
                </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                    <div class="text-center mb-4">
                        <div class="call-info mb-3">
                            <h6 id="audioCallerInfo">Loading...</h6>
                            <small class="text-muted" id="audioCallDetails">Loading...</small>
                </div>
                
                        <div class="audio-player-container">
                            <audio id="audioPlayer" controls class="w-100">
                                <source id="audioSource" src="" type="audio/wav">
                                Your browser does not support the audio element.
                            </audio>
                </div>
                
                        <div class="audio-controls mt-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="downloadRecording()">
                                <i class="fas fa-download me-1"></i>Download
                                    </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="shareRecording()">
                                <i class="fas fa-share me-1"></i>Share
                                    </button>
                        </div>
                    </div>
                    
                    <div class="recording-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Recording Information</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                <p><strong>File Size:</strong> <span id="audioFileSize">-</span></p>
                                <p><strong>Duration:</strong> <span id="audioDuration">-</span></p>
                                    </div>
                                    <div class="col-md-6">
                                <p><strong>Format:</strong> WAV (44.1kHz, 16-bit)</p>
                                <p><strong>Channels:</strong> Mono</p>
                                        </div>
                                    </div>
                                </div>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Clean VOIP Call Management System
let currentPage = 1;
let callsPerPage = 10;
let allCalls = [];
let filteredCalls = [];
let socket = null;
let map = null;
let marker = null;
let currentCallId = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Load initial data
    loadCalls();
    loadIncidentCategories();
    
    // Set up auto-refresh
    setInterval(loadCalls, 10000); // Refresh every 10 seconds
});

// Load calls from API
async function loadCalls() {
    try {
        const response = await fetch('/api/calls/public');
        const data = await response.json();
        
        if (data.success) {
            allCalls = data.calls;
            filteredCalls = [...allCalls];
            displayCalls();
            updateStatistics();
            updateCallsCount();
            console.log('📞 Calls loaded successfully:', data.count);
        } else {
            console.error('❌ Error loading calls:', data.error);
            showNotification('Failed to load calls: ' + data.error, 'danger');
        }
    } catch (error) {
        console.error('❌ Error loading calls:', error);
        showNotification('Error loading calls', 'danger');
    }
}

// Display calls in the UI
function displayCalls() {
    const container = document.getElementById('callsContainer');
    if (!container) return;
    
    if (filteredCalls.length === 0) {
        container.innerHTML = `
            <div class="no-calls">
                <i class="fas fa-phone-slash"></i>
                <h5>No calls found</h5>
                <p>No calls match your current filters or no calls have been made yet.</p>
                        </div>
                    `;
                    return;
                }
                
    // Calculate pagination
    const startIndex = (currentPage - 1) * callsPerPage;
    const endIndex = startIndex + callsPerPage;
    const pageCalls = filteredCalls.slice(startIndex, endIndex);
    
    let html = '';
    
    pageCalls.forEach(call => {
        const statusClass = getStatusClass(call.display_status || call.status);
        const statusText = getStatusText(call.display_status || call.status);
        
        // Add source indicator for AMI calls
        const sourceBadge = call.source === 'ami' ? 
            '<span class="badge bg-warning me-2"><i class="fas fa-phone-alt"></i> AMI</span>' : 
            '<span class="badge bg-info me-2"><i class="fas fa-mobile-alt"></i> Phone</span>';
        
        html += `
            <div class="call-item ${call.source === 'ami' ? 'ami-call' : ''}">
                <div class="call-header">
                    <div class="caller-info">
                        <h5>${sourceBadge}${call.caller_name || 'Unknown Caller'}</h5>
                        <small>${call.caller_number || call.caller_id || 'No Number'}</small>
                        <br>
                        <small class="text-muted">Call ID: ${call.id || call.call_id}</small>
                        ${call.source === 'ami' ? '<br><small class="text-warning"><i class="fas fa-asterisk"></i> Extension 1412</small>' : ''}
                </div>
                    <div class="call-status ${statusClass}">${statusText}</div>
        </div>
                
                <div class="call-details">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                ${formatDateTime(call.created_at || call.start_time)}
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            ${call.duration ? `<small class="text-muted"><i class="fas fa-stopwatch me-1"></i>${formatDuration(call.duration)}</small>` : ''}
                            </div>
                            </div>
                            </div>
                
                <div class="call-actions">
                    ${getCallActions(call)}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Get CSS class for call status
function getStatusClass(status) {
    switch (status) {
        case 'incoming':
        case 'ringing':
            return 'status-incoming';
        case 'active':
        case 'answered':
            return 'status-active';
        case 'ended':
        case 'rejected':
        case 'missed':
        case 'completed':
            return 'status-ended';
        default:
            return 'status-incoming';
    }
}

// Get display text for call status
function getStatusText(status) {
    switch (status) {
        case 'incoming':
        case 'ringing':
            return 'Incoming';
        case 'active':
        case 'answered':
            return 'Active';
        case 'ended':
            return 'Ended';
        case 'rejected':
            return 'Rejected';
        case 'missed':
            return 'Missed';
        case 'completed':
            return 'Completed';
        default:
            return status || 'Unknown';
    }
}

// Get action buttons for a call
function getCallActions(call) {
    const status = call.display_status || call.status;
    let actions = '';
    
    if (status === 'incoming' || status === 'ringing') {
        actions += `
            <button class="btn btn-call-action btn-answer" onclick="answerCall('${call.id || call.call_id}')">
                <i class="fas fa-phone me-1"></i>Answer
            </button>
            <button class="btn btn-call-action btn-hangup" onclick="rejectCall('${call.id || call.call_id}')">
                <i class="fas fa-phone-slash me-1"></i>Reject
            </button>
        `;
    } else if (status === 'active' || status === 'answered') {
        actions += `
            <button class="btn btn-call-action btn-hangup" onclick="hangupCall('${call.id || call.call_id}')">
                <i class="fas fa-phone-slash me-1"></i>Hang Up
            </button>
            <button class="btn btn-call-action btn-record" onclick="markCallDone('${call.id || call.call_id}')">
                <i class="fas fa-check me-1"></i>Mark Done
            </button>
        `;
        
        // Show recording status if recording
        if (call.is_recording) {
            actions += `
                <span class="recording-status">
                    <i class="fas fa-microphone"></i> Recording
                </span>
            `;
        }
    } else if (status === 'ended' || status === 'rejected' || status === 'missed' || status === 'completed') {
        // Show recording playback if available
        if (call.recording_path) {
            actions += `
                <button class="btn btn-outline-success btn-sm" onclick="playRecording('${call.id || call.call_id}', '${call.caller_name || 'Unknown'}', '${call.recording_path}')">
                    <i class="fas fa-play me-1"></i>Play Recording
                </button>
            `;
        }
        
        // Show incident report button for completed calls
        if (status === 'completed') {
            actions += `
                <button class="btn btn-outline-warning btn-sm" onclick="showIncidentReport('${call.id || call.call_id}')">
                    <i class="fas fa-exclamation-triangle me-1"></i>Report Incident
                </button>
            `;
        }
    }
    
    return actions;
}

// Test functions for debugging
function testCallLoading() {
    console.log('🧪 Testing call loading...');
    loadCalls();
}

function debugCurrentState() {
    console.log('🔍 Current system state:');
    console.log('All calls:', allCalls);
    console.log('Filtered calls:', filteredCalls);
    console.log('Current page:', currentPage);
    console.log('Calls per page:', callsPerPage);
}

function testRecordingSave() {
    console.log('🧪 Testing recording save...');
    
    if (allCalls.length === 0) {
        showNotification('No calls available to test recording save', 'warning');
        return;
    }
    
    // Find the first call with recording data
    const callWithRecording = allCalls.find(call => 
        call.is_recording || call.recording_path || 
        (call.status === 'active' || call.status === 'answered')
    );
    
    if (!callWithRecording) {
        showNotification('No active calls or calls with recordings found', 'warning');
                    return;
    }
    
    console.log('Testing recording save for call:', callWithRecording.id);
    
    // Test the recording save endpoint
    fetch(`/test-recording-save/${callWithRecording.id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`Recording save test successful for call ${callWithRecording.id}!`, 'success');
                console.log('✅ Recording save test result:', data);
                
                // Refresh calls to see updated recording status
                loadCalls();
            } else {
                showNotification(`Recording save test failed: ${data.error}`, 'danger');
                console.error('❌ Recording save test failed:', data);
            }
        })
        .catch(error => {
            console.error('❌ Error testing recording save:', error);
            showNotification('Error testing recording save', 'danger');
        });
}

// Test AGI Call function - Simulates a call from AGI server
function testAGICall() {
    console.log('🧪 Testing AGI Call simulation...');
    
    // Generate a unique test call ID
    const testCallId = `test_agi_${Date.now()}`;
    const testCallerId = `555-TEST-${Math.floor(Math.random() * 1000)}`;
    const testCallerName = `Test Caller ${Math.floor(Math.random() * 1000)}`;
    
    console.log('📞 Simulating AGI call:', {
        call_id: testCallId,
        caller_id: testCallerId,
        caller_name: testCallerName,
        extension: '1412',
        source: 'ami'
    });
    
    // Create mock AGI call data
    const mockAGICall = {
        call_id: testCallId,
        caller_id: testCallerId,
        caller_name: testCallerName,
        extension: '1412',
        channel: 'SIP/test-123',
        timestamp: new Date().toISOString(),
        source: 'ami',
        status: 'ringing',
        display_status: 'incoming'
    };
    
    // Add to calls list immediately for instant feedback
    allCalls.unshift(mockAGICall);
    filteredCalls = [...allCalls];
    
    // Update display and stats
    displayCalls();
    updateStatistics();
    
    // Show success notification
    showNotification(`🧪 AGI Call Test: ${testCallerName} (${testCallerId}) calling extension 1412`, 'success');
    
    // Call the test endpoint to simulate a real AGI call
    fetch('/test-agi-call', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Test AGI call endpoint successful:', data);
            showNotification(`✅ Test AGI call created via endpoint: ${data.call_data.call_id}`, 'success');
        } else {
            console.error('❌ Test AGI call endpoint failed:', data.error);
            showNotification(`❌ Test AGI call endpoint failed: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        console.error('❌ Error calling test AGI endpoint:', error);
        showNotification('❌ Error calling test AGI endpoint', 'danger');
    });
    
    // Simulate the WebSocket event that would normally come from the AGI server
    if (socket && socket.connected) {
        console.log('🔌 Emitting test AGI call event via WebSocket...');
        socket.emit('test_agi_call', mockAGICall);
        
        // Also simulate the incoming_call_1412 event
        setTimeout(() => {
            handleNewCall(mockAGICall);
            showNotification(`📞 Real-time update: AGI call ${testCallId} received!`, 'warning');
        }, 1000);
    } else {
        console.log('⚠️ WebSocket not connected, showing local update only');
        showNotification('⚠️ WebSocket not connected - showing local update only', 'warning');
    }
    
    // Auto-refresh after 3 seconds to show the call in the list
    setTimeout(() => {
        loadCalls();
        showNotification('🔄 Auto-refreshed calls list to show test AGI call', 'info');
    }, 3000);
}

// Initialize WebSocket connection
function initializeWebSocket() {
    console.log('🔌 Initializing WebSocket connection...');
    socket = io();
    
    socket.on('connect', () => {
        console.log('✅ WebSocket connected to admin interface');
        console.log('🔌 Socket ID:', socket.id);
    });
    
    socket.on('disconnect', () => {
        console.log('❌ WebSocket disconnected from admin interface');
    });
    
    socket.on('call_status_update', (data) => {
        console.log('📞 Call status update received:', data);
        updateCallStatus(data);
    });
    
    socket.on('new_call', (data) => {
        console.log('📞 New call event received:', data);
        handleNewCall(data);
    });
    
    socket.on('call_ended', (data) => {
        console.log('📞 Call ended event received:', data);
        handleCallEnded(data);
    });
    
    // Listen for test AGI call events
    socket.on('test_agi_call', (data) => {
        console.log('🧪 Test AGI call event received:', data);
        showNotification(`🔔 Test AGI Call: ${data.caller_name} (${data.caller_id})`, 'warning');
    });
    
    // Listen for real AGI calls from extension 1412
    socket.on('incoming_call_1412', (data) => {
        console.log('📞 Real AGI call received from extension 1412:', data);
        showNotification(`🔔 Real AGI Call: ${data.caller_id} calling extension ${data.extension}`, 'success');
        
        // Handle the real AGI call
        handleNewCall({
            ...data,
            source: 'ami',
            status: 'ringing',
            display_status: 'incoming'
        });
    });
    
    // Listen for all events to debug
    socket.onAny((eventName, ...args) => {
        console.log('🔍 WebSocket event received:', eventName, args);
    });
}

// Initialize map for incident modal
function initializeMap() {
    const mapContainer = document.getElementById('map');
    if (!mapContainer || mapContainer._leaflet_id) return; // Already initialized
    
    // Default coordinates (you can change these)
    const defaultLat = 10.5376;
    const defaultLng = 122.8361;
    
    // Initialize Leaflet map
    const map = L.map('map').setView([defaultLat, defaultLng], 13);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Add a marker for the default location
    const marker = L.marker([defaultLat, defaultLng]).addTo(map);
    
    // Handle map clicks to update coordinates and marker
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        // Update marker position
        marker.setLatLng([lat, lng]);
        
        // Update form fields
        document.getElementById('latitude').value = lat.toFixed(6);
        document.getElementById('longitude').value = lng.toFixed(6);
        
        // Get location name using reverse geocoding
        getLocationName(lat, lng);
    });
    
    // Store map reference
    mapContainer._leaflet_id = map._leaflet_id;
    mapContainer._leaflet_map = map;
    mapContainer._leaflet_marker = marker;
}

// Get location name from coordinates using Nominatim
async function getLocationName(lat, lng) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
        const data = await response.json();
        
        if (data.display_name) {
            document.getElementById('location_name').value = data.display_name.split(',')[0]; // Use first part of address
        }
    } catch (error) {
        console.error('Error getting location name:', error);
    }
}

// Load incident categories
async function loadIncidentCategories() {
    try {
        const response = await fetch('/api/incident-categories');
        const data = await response.json();
        
        if (data.success) {
            const categorySelect = document.getElementById('category_id');
            if (categorySelect) {
                // Clear existing options except the first one
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                
                // Add categories from API
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error loading incident categories:', error);
    }
}

// Show incident report modal
function showIncidentReport(callId) {
    currentCallId = callId;
    const call = allCalls.find(c => c.id === callId);
    
    if (call) {
        document.getElementById('callIdDisplay').textContent = callId;
        
        // Auto-fill caller number based on the call
        const callerNumberField = document.getElementById('caller_number');
        if (callerNumberField) {
            callerNumberField.value = call.caller_number || call.caller_id || '';
        }
        
        // Reset form
        document.getElementById('incidentForm').reset();
        
        // Auto-fill caller number again after reset
        if (callerNumberField) {
            callerNumberField.value = call.caller_number || call.caller_id || '';
        }
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('incidentModal'));
        modal.show();
        
        // Initialize map after modal is shown
        modal._element.addEventListener('shown.bs.modal', function() {
            initializeMap();
        }, { once: true });
    }
}

// Handle incident form submission
document.getElementById('incidentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const incidentData = {
        call_id: currentCallId,
        title: formData.get('title'),
        category_id: formData.get('category_id'),
        description: formData.get('description'),
        priority: formData.get('priority'),
        location_name: formData.get('location_name'),
        latitude: formData.get('latitude'),
        longitude: formData.get('longitude'),
        caller_number: formData.get('caller_number')
    };
    
    // Submit incident report
    submitIncidentReport(incidentData);
});

// Submit incident report to server
async function submitIncidentReport(incidentData) {
    try {
        const response = await fetch('/api/incidents', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(incidentData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Incident report submitted successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('incidentModal')).hide();
            
            // Update pending reports count
            updateStatistics();
        } else {
            showNotification('Failed to submit report: ' + data.error, 'danger');
        }
    } catch (error) {
        console.error('Error submitting incident report:', error);
        showNotification('Error submitting report', 'danger');
    }
}

// Call management functions with echo prevention
async function answerCall(callId) {
    try {
        // Find the call to determine if it's an AMI call
        const call = allCalls.find(c => c.id === callId || c.call_id === callId);
        const isAMICall = call && call.source === 'ami';
        
        if (isAMICall) {
            // Handle AMI call differently - use the AMI endpoint
            console.log('🔔 Answering AMI call:', callId);
            
            const response = await fetch('/asterisk/answer_call', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `call_id=${callId}&channel=${call.sip_channel || ''}`
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('AMI call answered successfully via Asterisk', 'success');
                
                // Update call status locally
                if (call) {
                    call.status = 'answered';
                    call.display_status = 'active';
                    call.answered_time = new Date().toISOString();
                }
                
                loadCalls();
            } else {
                showNotification('Failed to answer AMI call: ' + data.error, 'danger');
            }
        } else {
            // Handle regular phone simulator call
            const response = await fetch(`/api/calls/${callId}/answer`, { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                showNotification('Call answered successfully', 'success');
                
                // Show incident report modal immediately
                setTimeout(() => showIncidentReport(callId), 1000);
                
                loadCalls();
            } else {
                showNotification('Failed to answer call: ' + data.error, 'danger');
            }
        }
    } catch (error) {
        console.error('Error answering call:', error);
        showNotification('Error answering call', 'danger');
    }
}

async function hangupCall(callId) {
    try {
        // Find the call to determine if it's an AMI call
        const call = allCalls.find(c => c.id === callId || c.call_id === callId);
        const isAMICall = call && call.source === 'ami';
        
        if (isAMICall) {
            // Handle AMI call hangup differently - use the AMI endpoint
            console.log('🔔 Hanging up AMI call:', callId);
            
            const response = await fetch('/asterisk/hangup_call', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `call_id=${callId}&channel=${call.sip_channel || ''}`
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('AMI call ended successfully via Asterisk', 'success');
                
                // Update call status locally
                if (call) {
                    call.status = 'ended';
                    call.display_status = 'ended';
                    call.end_time = new Date().toISOString();
                }
                
                loadCalls();
            } else {
                showNotification('Failed to end AMI call: ' + data.error, 'danger');
            }
        } else {
            // Handle regular phone simulator call
            const response = await fetch(`/api/calls/${callId}/hangup`, { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                showNotification('Call ended successfully', 'success');
                loadCalls();
            } else {
                showNotification('Failed to end call: ' + data.error, 'danger');
            }
        }
    } catch (error) {
        console.error('Error ending call:', error);
        showNotification('Error ending call', 'danger');
    }
}

async function rejectCall(callId) {
    try {
        // Find the call to determine if it's an AMI call
        const call = allCalls.find(c => c.id === callId || c.call_id === callId);
        const isAMICall = call && call.source === 'ami';
        
        if (isAMICall) {
            // Handle AMI call rejection differently - use the AMI endpoint
            console.log('🔔 Rejecting AMI call:', callId);
            
            const response = await fetch('/asterisk/hangup_call', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `call_id=${callId}&channel=${call.sip_channel || ''}&cause=21`
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('AMI call rejected successfully via Asterisk', 'success');
                
                // Update call status locally
                if (call) {
                    call.status = 'rejected';
                    call.display_status = 'ended';
                    call.end_time = new Date().toISOString();
                }
                
                loadCalls();
            } else {
                showNotification('Failed to reject AMI call: ' + data.error, 'danger');
            }
        } else {
            // Handle regular phone simulator call
            const response = await fetch(`/api/calls/${callId}/reject`, { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                showNotification('Call rejected successfully', 'success');
                loadCalls();
            } else {
                showNotification('Failed to reject call: ' + data.error, 'danger');
            }
        }
    } catch (error) {
        console.error('Error rejecting call:', error);
        showNotification('Error rejecting call', 'danger');
    }
}

async function startRecording(callId) {
    try {
        const response = await fetch(`/api/calls/${callId}/start-recording`, { method: 'POST' });
        const data = await response.json();
        
            if (data.success) {
            showNotification('Recording started successfully', 'success');
            loadCalls();
            } else {
            showNotification('Failed to start recording: ' + data.error, 'danger');
        }
    } catch (error) {
        console.error('Error starting recording:', error);
        showNotification('Error starting recording', 'danger');
    }
}

async function stopRecording(callId) {
    try {
        const response = await fetch(`/api/calls/${callId}/stop-recording`, { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showNotification('Recording stopped successfully', 'success');
            loadCalls();
        } else {
            showNotification('Failed to stop recording: ' + data.error, 'danger');
        }
    } catch (error) {
        console.error('Error stopping recording:', error);
        showNotification('Error stopping recording', 'danger');
    }
}

async function markCallDone(callId) {
    try {
        console.log('✅ Marking call as done:', callId);
        
        const response = await fetch(`/api/calls/${callId}/mark-done`, { method: 'POST' });
        const data = await response.json();
        
            if (data.success) {
            showNotification('Call marked as done successfully', 'success');
            loadCalls();
            } else {
            showNotification('Failed to mark call as done: ' + data.error, 'danger');
        }
    } catch (error) {
        console.error('Error marking call as done:', error);
        showNotification('Error marking call as done', 'danger');
    }
}

// Utility functions
function formatDuration(seconds) {
    if (seconds < 60) return `${seconds}s`;
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}m ${remainingSeconds}s`;
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString();
}

function updateCallsCount() {
    const countElement = document.getElementById('callsCount');
    if (countElement) {
        countElement.textContent = `${filteredCalls.length} calls`;
    }
}

function updateStatistics() {
    if (allCalls.length === 0) return;
    
    const totalCalls = allCalls.length;
    const activeCalls = allCalls.filter(call => {
        const status = call.display_status || call.status;
        return status === 'active' || status === 'answered';
    }).length;
    const totalRecordings = allCalls.filter(call => call.is_recording || call.recording_path).length;
    const pendingReports = allCalls.filter(call => {
        const status = call.display_status || call.status;
        return (status === 'ended' || status === 'rejected' || status === 'missed') && !call.incident_reported;
    }).length;
    
    // Call source counts
    const amiCalls = allCalls.filter(call => call.source === 'ami').length;
    const phoneCalls = allCalls.filter(call => call.source === 'phone_simulator' || !call.source).length;
    
    document.getElementById('totalCalls').textContent = totalCalls;
    document.getElementById('activeCalls').textContent = activeCalls;
    document.getElementById('totalRecordings').textContent = totalRecordings;
    document.getElementById('pendingReports').textContent = pendingReports;
    
    // Update call source counts
    const amiCallCountElement = document.getElementById('amiCallCount');
    const phoneCallCountElement = document.getElementById('phoneCallCount');
    
    if (amiCallCountElement) amiCallCountElement.textContent = amiCalls;
    if (phoneCallCountElement) phoneCallCountElement.textContent = phoneCalls;
    
    console.log('📊 Statistics updated:', { 
        totalCalls, 
        activeCalls, 
        totalRecordings, 
        pendingReports,
        amiCalls,
        phoneCalls
    });
}

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const phoneFilter = document.getElementById('phoneFilter').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const sourceFilter = document.getElementById('sourceFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    
    filteredCalls = allCalls.filter(call => {
        let matches = true;
        
        // Search filter (caller name, number, notes)
        if (searchTerm) {
            const searchFields = [
                call.caller_name || '',
                call.caller_number || call.caller_id || '',
                call.notes || ''
            ].join(' ').toLowerCase();
            matches = matches && searchFields.includes(searchTerm);
        }

        // Phone number filter
        if (phoneFilter) {
            const callNumber = call.caller_number || call.caller_id || '';
            matches = matches && callNumber.toLowerCase().includes(phoneFilter);
        }
        
        // Status filter
        if (statusFilter) {
            const callStatus = call.display_status || call.status;
            if (statusFilter === 'incoming') {
                matches = matches && (callStatus === 'incoming' || callStatus === 'ringing');
            } else if (statusFilter === 'active') {
                matches = matches && (callStatus === 'active' || callStatus === 'answered');
            } else if (statusFilter === 'ended') {
                matches = matches && (callStatus === 'ended' || callStatus === 'rejected' || callStatus === 'missed' || callStatus === 'completed');
            } else {
                matches = matches && callStatus === statusFilter;
            }
        }
        
        // Source filter (AMI vs Phone Simulator)
        if (sourceFilter) {
            const callSource = call.source || 'phone_simulator';
            matches = matches && callSource === sourceFilter;
        }
        
        // Date filter
        if (dateFilter) {
            const callDate = new Date(call.created_at || call.start_time).toISOString().split('T')[0];
            matches = matches && callDate === dateFilter;
        }
        
        return matches;
    });
    
    currentPage = 1;
    displayCalls();
    console.log('🔍 Filters applied:', { searchTerm, phoneFilter, statusFilter, sourceFilter, dateFilter, filteredCount: filteredCalls.length });
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('phoneFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('sourceFilter').value = '';
    document.getElementById('dateFilter').value = '';
    applyFilters(); // Re-apply filters to show all calls
    showNotification('All filters cleared', 'info');
}

function setDateFilter() {
    const today = new Date().toISOString().split('T')[0];
    const dateFilter = document.getElementById('dateFilter');
    if (dateFilter) {
        dateFilter.value = today;
    }
}

// Quick action functions
function simulateCall() {
    const callerId = prompt('Enter caller ID:', '555-9999');
    const callerName = prompt('Enter caller name:', 'Test Caller');
    
    if (callerId) {
        // Simulate incoming call
        const mockCall = {
            id: `sim_${Date.now()}`,
            caller_name: callerName || 'Test Caller',
            caller_number: callerId,
            status: 'incoming',
            created_at: new Date().toISOString()
        };
        
        // Add to calls list
        allCalls.unshift(mockCall);
        filteredCalls = [...allCalls];
        displayCalls();
        updateStatistics();
        
        showNotification(`Simulating incoming call from ${callerName || callerId}`, 'info');
    }
}

function makeCall() {
    const fromNumber = prompt('Enter from number:', '555-0000');
    const toNumber = prompt('Enter to number:', '555-1234');
    
    if (fromNumber && toNumber) {
        showNotification('Outbound call feature coming soon', 'info');
    }
}

function exportData() {
    showNotification('Export feature coming soon', 'info');
}

function showAnalytics() {
    showNotification('Analytics feature coming soon', 'info');
}

function refreshData() {
    loadCalls();
    showNotification('Data refreshed', 'info');
}

function viewCallDetails(callId) {
    showNotification('Call details feature coming soon', 'info');
}

// WebSocket event handlers
function handleNewCall(data) {
    console.log('📞 New call received:', data);
    console.log('📊 Call data details:', {
        call_id: data.call_id,
        caller_id: data.caller_id,
        source: data.source,
        status: data.status
    });
    
    // Check if this is an AMI call (from extension 1412)
    const isAMICall = data.source === 'ami';
    console.log('🔔 Is AMI call?', isAMICall);
    
    // Add the new call to our local list
    const newCall = {
        id: data.call_id || data.id,
        call_id: data.call_id || data.id,
        caller_id: data.caller_id,
        caller_name: data.caller_name,
        caller_number: data.caller_id,
        status: data.status,
        display_status: data.status === 'ringing' ? 'incoming' : data.status,
        direction: data.direction || 'inbound',
        start_time: data.start_time,
        created_at: data.start_time,
        is_recording: false,
        source: data.source || 'phone_simulator',  // Track call source
        sip_channel: data.sip_channel || null      // Store SIP channel for AMI calls
    };
    
    console.log('📝 Processed new call object:', newCall);
    
    // Add to beginning of list
    allCalls.unshift(newCall);
    filteredCalls = [...allCalls];
    
    console.log('📊 Updated calls lists - Total calls:', allCalls.length, 'Filtered calls:', filteredCalls.length);
    
    // Update display and stats
    displayCalls();
    updateStatistics();
    
    // Show different notification for AMI calls
    if (isAMICall) {
        console.log('🔔 AMI call detected, showing special notification');
        showNotification(`AMI Call from ${data.caller_name || data.caller_id} (Extension 1412)`, 'warning');
    } else {
        showNotification(`New incoming call from ${data.caller_name || data.caller_id}`, 'info');
    }
}

function handleCallEnded(data) {
    console.log('📞 Call ended:', data);
    
    // Update the call in our local list
    const callIndex = allCalls.findIndex(call => call.id === data.call_id);
    if (callIndex !== -1) {
        allCalls[callIndex].status = 'ended';
        allCalls[callIndex].display_status = 'ended';
        allCalls[callIndex].end_time = data.end_time || new Date().toISOString();
        
        // Update filtered list
        filteredCalls = [...allCalls];
        
        // Update display and stats
        displayCalls();
        updateStatistics();
    }
    
    showNotification(`Call with ${data.caller_name || data.caller_id} ended`, 'info');
}

function updateCallStatus(data) {
    console.log('📞 Call status update:', data);
    
    // Update the call in our local list
    const callIndex = allCalls.findIndex(call => call.id === data.call_id);
    if (callIndex !== -1) {
        Object.assign(allCalls[callIndex], data);
        
        // Update display status
        if (data.status === 'ringing') {
            allCalls[callIndex].display_status = 'incoming';
        } else if (data.status === 'answered') {
            allCalls[callIndex].display_status = 'active';
        } else if (['ended', 'rejected', 'missed'].includes(data.status)) {
            allCalls[callIndex].display_status = 'ended';
        }
        
        // Update filtered list
        filteredCalls = [...allCalls];
        
        // Update display and stats
        displayCalls();
        updateStatistics();
    }
}

// Show notification with better styling
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
                ${type === 'success' ? '<i class="fas fa-check-circle text-success me-2"></i>' : 
                  type === 'warning' ? '<i class="fas fa-exclamation-triangle text-warning me-2"></i>' :
                  type === 'danger' ? '<i class="fas fa-times-circle text-danger me-2"></i>' :
                  '<i class="fas fa-info-circle text-info me-2"></i>'}
            </div>
            <div class="flex-grow-1">
                ${message}
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Show recording save progress
function showRecordingSaveProgress(callId, action = 'saving') {
    const progressId = `recording-progress-${callId}`;
    
    // Remove existing progress notification
    const existing = document.getElementById(progressId);
    if (existing) {
        existing.remove();
    }
    
    const progressNotification = document.createElement('div');
    progressNotification.id = progressId;
    progressNotification.className = 'alert alert-info position-fixed';
    progressNotification.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
    progressNotification.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div>
                <strong>Recording ${action}...</strong><br>
                <small>Call ID: ${callId}</small>
            </div>
        </div>
    `;
    
    document.body.appendChild(progressNotification);
    
    return progressId;
}

// Hide recording save progress
function hideRecordingSaveProgress(progressId) {
    const progress = document.getElementById(progressId);
    if (progress) {
        progress.remove();
    }
}

// Fix echo issue by improving audio handling
function preventAudioEcho() {
    // This function addresses the echo issue by:
    // 1. Ensuring proper audio stream isolation
    // 2. Preventing feedback loops
    // 3. Using echo cancellation
    
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
                sampleRate: 44100,
                channelCount: 1
            }
        }).then(stream => {
            // Store stream for later use
            window.audioStream = stream;
            console.log('✅ Audio stream initialized with echo cancellation');
        }).catch(error => {
            console.error('❌ Error initializing audio stream:', error);
        });
    }
}

// Initialize audio with echo prevention
document.addEventListener('DOMContentLoaded', function() {
    preventAudioEcho();
});

// Audio player functions
function playRecording(callId, callerName, recordingPath) {
    console.log('🎵 Playing recording for call:', callId);
    
    // Update modal content
    document.getElementById('audioCallIdDisplay').textContent = callId;
    document.getElementById('audioCallerInfo').textContent = callerName;
    document.getElementById('audioCallDetails').textContent = `Call ID: ${callId} | Recording: ${recordingPath}`;
    
    // Set audio source
    const audioPlayer = document.getElementById('audioPlayer');
    const audioSource = document.getElementById('audioSource');
    
    // Get the recording URL
    const recordingUrl = `/api/calls/${callId}/get-latest-recording`;
    audioSource.src = recordingUrl;
    audioPlayer.load();
    
    // Get recording information
    getRecordingInfo(callId, recordingPath);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('audioPlayerModal'));
    modal.show();
}

async function getRecordingInfo(callId, recordingPath) {
    try {
        // Get file information from the server
        const response = await fetch(`/api/calls/${callId}/recording-info`);
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                document.getElementById('audioFileSize').textContent = formatFileSize(data.file_size);
                document.getElementById('audioDuration').textContent = formatDuration(data.duration);
            }
        }
    } catch (error) {
        console.error('Error getting recording info:', error);
        // Fallback: try to get info from the file path
        document.getElementById('audioFileSize').textContent = 'Unknown';
        document.getElementById('audioDuration').textContent = 'Unknown';
    }
}

function downloadRecording() {
    const callId = document.getElementById('audioCallIdDisplay').textContent;
    const downloadUrl = `/api/calls/${callId}/get-latest-recording`;
    
    // Create a temporary link and trigger download
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = `call_recording_${callId}.wav`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Recording download started', 'success');
}

function shareRecording() {
    const callId = document.getElementById('audioCallIdDisplay').textContent;
    const shareUrl = `${window.location.origin}/api/calls/${callId}/get-latest-recording`;
    
    if (navigator.share) {
        navigator.share({
            title: `Call Recording - ${callId}`,
            text: `Call recording from ${callId}`,
            url: shareUrl
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(shareUrl).then(() => {
            showNotification('Recording URL copied to clipboard', 'success');
        }).catch(() => {
            showNotification('Recording URL: ' + shareUrl, 'info');
        });
    }
}

// Utility function to format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Function to update category info in the modal
function updateCategoryInfo() {
    const categoryId = document.getElementById('category_id').value;
    const categoryInfoDiv = document.getElementById('categoryInfo');
    const categoryPrioritySpan = document.getElementById('categoryPriority');
    const categoryResponseTimeSpan = document.getElementById('categoryResponseTime');
    const prioritySelect = document.getElementById('priority');

    if (categoryId) {
        categoryInfoDiv.style.display = 'block';
        fetch(`/api/incident-categories/${categoryId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const category = data.category;
                    categoryPrioritySpan.textContent = `Priority: ${category.priority}`;
                    categoryResponseTimeSpan.textContent = `Response Time: ${category.response_time}`;
                    
                    // Auto-fill priority based on category
                    if (prioritySelect && category.priority) {
                        prioritySelect.value = category.priority;
                    }
                } else {
                    categoryInfoDiv.style.display = 'none';
                    categoryPrioritySpan.textContent = 'N/A';
                    categoryResponseTimeSpan.textContent = 'N/A';
                }
            })
            .catch(error => {
                console.error('Error fetching category info:', error);
                categoryInfoDiv.style.display = 'none';
                categoryPrioritySpan.textContent = 'N/A';
                categoryResponseTimeSpan.textContent = 'N/A';
            });
    } else {
        categoryInfoDiv.style.display = 'none';
        categoryPrioritySpan.textContent = 'N/A';
        categoryResponseTimeSpan.textContent = 'N/A';
    }
}
</script>
</body>
</html> 