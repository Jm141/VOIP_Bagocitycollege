{% extends "base.html" %}

{% block title %}Dashboard - VOIP System{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page header -->
    <div>
        <h1 class="text-2xl font-bold text-gray-900">VOIP System Dashboard</h1>
        <p class="mt-1 text-sm text-gray-600">Comprehensive overview of your VOIP system performance and call analytics</p>
    </div>

    <!-- Enhanced Statistics cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white overflow-hidden shadow rounded-lg border-l-4 border-blue-500">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Active Calls</dt>
                            <dd class="text-lg font-medium text-gray-900" id="active-calls-count">{{ stats.active_calls }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg border-l-4 border-green-500">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total Calls Today</dt>
                            <dd class="text-lg font-medium text-gray-900" id="total-calls-today">{{ stats.total_calls_today }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg border-l-4 border-yellow-500">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Recordings</dt>
                            <dd class="text-lg font-medium text-gray-900" id="total-recordings">{{ stats.total_recordings|default(0) }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg border-l-4 border-purple-500">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Success Rate</dt>
                            <dd class="text-lg font-medium text-gray-900" id="success-rate">{{ stats.success_rate|default(95) }}%</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Call Analytics Row -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Call Volume Chart -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Call Volume (24h)</h3>
                <div class="h-64">
                    <canvas id="callVolumeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Call Duration Distribution -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Call Duration Distribution</h3>
                <div class="h-64">
                    <canvas id="durationChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Call Status Breakdown -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Call Status Breakdown</h3>
                <div class="h-64">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Historical Data Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Weekly Call Trends -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Weekly Call Trends</h3>
                <div class="h-64">
                    <canvas id="weeklyTrendsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Peak Hours Analysis -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Peak Hours Analysis</h3>
                <div class="h-64">
                    <canvas id="peakHoursChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Call Activity -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Recent Call Activity</h3>
                <a href="/calls" class="text-blue-600 hover:text-blue-800 text-sm font-medium">View All Calls â†’</a>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Caller</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Number</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recording</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="recent-calls-table">
                        <!-- Recent calls will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- System Status and Quick Actions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- System Status -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">System Status</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-500">SIP Service</span>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" id="sip-status">
                            Online
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-500">WebSocket</span>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" id="websocket-status">
                            Connected
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-500">Database</span>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" id="database-status">
                            Active
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-500">Audio Recording</span>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" id="audio-status">
                            Ready
                        </span>
                </div>
            </div>
        </div>
    </div>

        <!-- Quick Actions -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="makeTestCall()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                Make Test Call
            </button>
            <button onclick="simulateIncomingCall()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                Simulate Incoming Call
            </button>
            <button onclick="getSIPStatus()" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                Get SIP Status
            </button>
            <button onclick="refreshDashboard()" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                Refresh Dashboard
            </button>
            </div>
        </div>
    </div>

    <!-- SIP System Status -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">SIP System Status</h3>
        <div id="sip-status" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600" id="active-channels">-</div>
                <div class="text-sm text-gray-600">Active Channels</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600" id="sip-registrations">-</div>
                <div class="text-sm text-gray-600">SIP Registrations</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-purple-600" id="system-uptime">-</div>
                <div class="text-sm text-gray-600">Uptime (s)</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-orange-600" id="last-call-time">-</div>
                <div class="text-sm text-gray-600">Last Call</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Enhanced Dashboard with Historical Data and Analytics
    let callVolumeChart, durationChart, statusChart, weeklyTrendsChart, peakHoursChart;
    let dashboardData = {};

    // Initialize all charts
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        loadDashboardData();
        getSIPStatus();
        
        // Update dashboard every 30 seconds
        setInterval(loadDashboardData, 30000);
        setInterval(getSIPStatus, 30000);
    });

    // Initialize all dashboard charts
    function initializeCharts() {
        // Call Volume Chart (24h)
        const callVolumeCtx = document.getElementById('callVolumeChart');
        if (callVolumeCtx) {
            callVolumeChart = new Chart(callVolumeCtx, {
        type: 'line',
        data: {
                    labels: generateHourLabels(),
            datasets: [{
                label: 'Calls',
                        data: generateRandomData(24),
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        // Duration Distribution Chart
        const durationCtx = document.getElementById('durationChart');
        if (durationCtx) {
            durationChart = new Chart(durationCtx, {
                type: 'doughnut',
                data: {
                    labels: ['0-1 min', '1-5 min', '5-15 min', '15+ min'],
                    datasets: [{
                        data: [15, 35, 30, 20],
                        backgroundColor: [
                            '#3B82F6', '#10B981', '#F59E0B', '#EF4444'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // Status Breakdown Chart
        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            statusChart = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['Answered', 'Missed', 'Rejected', 'In Progress'],
                    datasets: [{
                        data: [65, 20, 10, 5],
                        backgroundColor: [
                            '#10B981', '#EF4444', '#F59E0B', '#3B82F6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // Weekly Trends Chart
        const weeklyCtx = document.getElementById('weeklyTrendsChart');
        if (weeklyCtx) {
            weeklyTrendsChart = new Chart(weeklyCtx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Calls',
                        data: generateRandomData(7),
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        // Peak Hours Chart
        const peakCtx = document.getElementById('peakHoursChart');
        if (peakCtx) {
            peakHoursChart = new Chart(peakCtx, {
                type: 'bar',
                data: {
                    labels: ['6AM', '9AM', '12PM', '3PM', '6PM', '9PM'],
                    datasets: [{
                        label: 'Call Volume',
                        data: [5, 25, 15, 20, 30, 10],
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgb(16, 185, 129)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
            scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 5 } }
                    }
                }
            });
        }
    }

    // Generate hour labels for 24-hour chart
    function generateHourLabels() {
        const labels = [];
        for (let i = 0; i < 24; i++) {
            labels.push(`${i.toString().padStart(2, '0')}:00`);
        }
        return labels;
    }

    // Generate random data for charts
    function generateRandomData(count) {
        const data = [];
        for (let i = 0; i < count; i++) {
            data.push(Math.floor(Math.random() * 20) + 1);
        }
        return data;
    }

    // Load dashboard data from server
    async function loadDashboardData() {
        try {
            const response = await fetch('/api/dashboard/stats');
            const data = await response.json();
            
            if (data.success) {
                dashboardData = data.stats;
                updateDashboardStats();
                updateRecentCallsTable();
            }
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            // Use mock data if server is not available
            loadMockDashboardData();
        }
    }

    // Load mock data for development
    function loadMockDashboardData() {
        dashboardData = {
            active_calls: Math.floor(Math.random() * 5) + 1,
            total_calls_today: Math.floor(Math.random() * 50) + 20,
            total_recordings: Math.floor(Math.random() * 30) + 15,
            success_rate: Math.floor(Math.random() * 20) + 80,
            recent_calls: generateMockRecentCalls()
        };
        updateDashboardStats();
        updateRecentCallsTable();
    }

    // Generate mock recent calls
    function generateMockRecentCalls() {
        const calls = [];
        const statuses = ['answered', 'missed', 'rejected', 'in_progress'];
        const names = ['John Doe', 'Jane Smith', 'Bob Johnson', 'Alice Brown', 'Charlie Wilson'];
        
        for (let i = 0; i < 10; i++) {
            calls.push({
                id: `call_${i}`,
                caller_name: names[Math.floor(Math.random() * names.length)],
                caller_number: `555-${Math.floor(Math.random() * 9000) + 1000}`,
                status: statuses[Math.floor(Math.random() * statuses.length)],
                duration: Math.floor(Math.random() * 300) + 30,
                created_at: new Date(Date.now() - Math.random() * 86400000).toISOString(),
                has_recording: Math.random() > 0.5
            });
        }
        return calls;
    }

    // Update dashboard statistics
    function updateDashboardStats() {
        if (dashboardData.active_calls !== undefined) {
            document.getElementById('active-calls-count').textContent = dashboardData.active_calls;
        }
        if (dashboardData.total_calls_today !== undefined) {
            document.getElementById('total-calls-today').textContent = dashboardData.total_calls_today;
        }
        if (dashboardData.total_recordings !== undefined) {
            document.getElementById('total-recordings').textContent = dashboardData.total_recordings;
        }
        if (dashboardData.success_rate !== undefined) {
            document.getElementById('success-rate').textContent = dashboardData.success_rate + '%';
        }
    }

    // Update recent calls table
    function updateRecentCallsTable() {
        const tableBody = document.getElementById('recent-calls-table');
        if (!tableBody || !dashboardData.recent_calls) return;

        tableBody.innerHTML = dashboardData.recent_calls.map(call => `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${call.caller_name}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${call.caller_number}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusBadgeClass(call.status)}">
                        ${getStatusText(call.status)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${formatDuration(call.duration)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${formatDateTime(call.created_at)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${call.has_recording ? 
                        '<span class="text-green-600"><i class="fas fa-check"></i> Yes</span>' : 
                        '<span class="text-gray-400"><i class="fas fa-times"></i> No</span>'
                    }
                </td>
            </tr>
        `).join('');
    }

    // Get status badge class
    function getStatusBadgeClass(status) {
        switch(status) {
            case 'answered': return 'bg-green-100 text-green-800';
            case 'missed': return 'bg-red-100 text-red-800';
            case 'rejected': return 'bg-yellow-100 text-yellow-800';
            case 'in_progress': return 'bg-blue-100 text-blue-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    // Get status text
    function getStatusText(status) {
        switch(status) {
            case 'answered': return 'Answered';
            case 'missed': return 'Missed';
            case 'rejected': return 'Rejected';
            case 'in_progress': return 'In Progress';
            default: return status;
        }
    }

    // Format duration
    function formatDuration(seconds) {
        if (seconds < 60) return `${seconds}s`;
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes}m ${remainingSeconds}s`;
    }

    // Format date time
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString();
    }

    // Quick action functions
    function makeTestCall() {
        const fromNumber = prompt('Enter from number:', '555-0000');
        const toNumber = prompt('Enter to number:', '555-1234');
        
        if (fromNumber && toNumber) {
            fetch('/api/calls/make', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    from_number: fromNumber,
                    to_number: toNumber
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Test call initiated successfully!');
                    loadDashboardData();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error making test call');
            });
        }
    }

    function simulateIncomingCall() {
        const callerId = prompt('Enter caller ID:', '555-9999');
        const callerName = prompt('Enter caller name:', 'Test Caller');
        
        if (callerId) {
            // Simulate incoming call
            const mockCall = {
                id: `sim_${Date.now()}`,
                caller_name: callerName || 'Test Caller',
                caller_number: callerId,
                status: 'incoming',
                created_at: new Date().toISOString()
            };
            
            // Add to recent calls
            if (dashboardData.recent_calls) {
                dashboardData.recent_calls.unshift(mockCall);
                if (dashboardData.recent_calls.length > 10) {
                    dashboardData.recent_calls.pop();
                }
                updateRecentCallsTable();
            }
            
            alert(`Simulating incoming call from ${callerName || callerId} (${callerId})`);
        }
    }

    function getSIPStatus() {
        fetch('/api/sip/status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('active-channels').textContent = data.data.total_channels || 0;
                    document.getElementById('sip-registrations').textContent = data.data.sip_registrations || 0;
                    document.getElementById('system-uptime').textContent = data.data.system_uptime ? Math.floor((Date.now() / 1000) - data.data.system_uptime) : 0;
                    document.getElementById('last-call-time').textContent = data.data.last_call_time ? 'Recent' : 'None';
                } else {
                    // Use mock data if SIP status fails
                    document.getElementById('active-channels').textContent = Math.floor(Math.random() * 5) + 1;
                    document.getElementById('sip-registrations').textContent = Math.floor(Math.random() * 10) + 5;
                    document.getElementById('system-uptime').textContent = Math.floor(Math.random() * 3600) + 1800;
                    document.getElementById('last-call-time').textContent = 'Recent';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Use mock data on error
                document.getElementById('active-channels').textContent = Math.floor(Math.random() * 5) + 1;
                document.getElementById('sip-registrations').textContent = Math.floor(Math.random() * 10) + 5;
                document.getElementById('system-uptime').textContent = Math.floor(Math.random() * 3600) + 1800;
                document.getElementById('last-call-time').textContent = 'Recent';
            });
    }

    function refreshDashboard() {
        loadDashboardData();
        getSIPStatus();
        alert('Dashboard refreshed successfully!');
    }

    // Socket.IO event handlers for real-time updates
    if (typeof socket !== 'undefined') {
    socket.on('call_status_update', function(data) {
        console.log('Call status update:', data);
            loadDashboardData();
    });

    socket.on('call_notification', function(data) {
        console.log('Incoming call notification:', data);
        if (confirm(`Incoming call from ${data.caller_name || data.caller_id} (${data.caller_id})\n\nAnswer?`)) {
            socket.emit('accept_call', {
                call_id: data.call_id,
                    user_id: 'admin'
            });
        } else {
            socket.emit('reject_call', {
                call_id: data.call_id,
                    user_id: 'admin',
                reason: 'user_rejected'
            });
        }
    });
    }
</script>
{% endblock %} 